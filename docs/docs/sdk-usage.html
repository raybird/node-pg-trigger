<h1>ğŸ’ SDK ä½¿ç”¨æŒ‡å—</h1>
<p>æˆ‘å€‘çš„ SDK æä¾›äº†ä¸€å¥—æ¥µç°¡çš„ä»‹é¢ä¾†èˆ‡è³‡æ–™åº«äº’å‹•ã€‚</p>

<h2>1. å»ºç«‹ SDK</h2>
<pre><code>
import { createSdk } from './client';
const sdk = createSdk('http://localhost:5000');
</code></pre>

<h2>2. å³æ™‚è¨‚é–±ï¼ˆCollectionï¼‰</h2>
<pre><code>
const unsubscribe = await sdk
  .collection('users')
  .onSnapshot(({ action, record }) => {
    console.log('ç•°å‹•é¡å‹ï¼š', action);
    console.log('æœ€æ–°è³‡æ–™ï¼š', record);
  });

// é›¢é–‹é é¢æ™‚å»ºè­°è§£é™¤è¨‚é–±
unsubscribe();
</code></pre>

<h2>3. valueChanges / subscribe åˆ¥å</h2>
<pre><code>
await sdk.collection('users').valueChanges((rows) => {
  console.log('åªæœ‰è³‡æ–™æœ¬é«”ï¼š', rows);
});

await sdk.collection('users').subscribe(({ action, record }) => {
  console.log('subscribe åˆ¥åï¼š', action, record);
});
</code></pre>

<h2>4. æ–‡ä»¶æ“ä½œï¼ˆDocumentï¼‰</h2>
<pre><code>
const userRef = sdk.doc('users', 1);

const exists = await userRef.exists();
if (exists) {
  await userRef.update({ name: 'Ray Bird' });
}

await userRef.set({ status: 'active' }, { merge: true });
await userRef.delete();
</code></pre>

<h2>5. æŸ¥è©¢èˆ‡ cursor è¦–çª—</h2>
<pre><code>
const rows = await sdk
  .collection('users')
  .where('status', '==', 'active')
  .orderBy('created_at', 'asc')
  .startAfter('2026-02-20T00:00:00.000Z')
  .endAt('2026-02-20T23:59:59.999Z')
  .limit(20)
  .get();

const count = await sdk
  .collection('users')
  .where('status', '==', 'active')
  .count();
</code></pre>

<h2>6. FieldValue ä¼ºæœå™¨åŸå­æ“ä½œ</h2>
<pre><code>
import { FieldValue } from './client';

await sdk.collection('posts').add({
  title: 'New Post',
  createdAt: FieldValue.serverTimestamp(),
});

await sdk.doc('posts', 1).update({
  views: FieldValue.increment(1),
  tags: FieldValue.arrayUnion('news'),
});
</code></pre>

<h2>7. withConverter æ¬„ä½æ˜ å°„</h2>
<pre><code>
const userConverter = {
  fromFirestore(row) {
    return { id: row.id, displayName: row.name };
  },
  toFirestore(model) {
    return { name: model.displayName };
  },
};

const users = sdk.collection('users').withConverter(userConverter);
const list = await users.get();
console.log(list[0].displayName);
</code></pre>

<h2>8. èšåˆæŸ¥è©¢ï¼ˆAggregationï¼‰</h2>
<p>æä¾›é«˜æ•ˆçš„ä¼ºæœå™¨ç«¯çµ±è¨ˆåŠŸèƒ½ï¼Œç„¡éœ€æ‹‰å–å¤§é‡åŸå§‹è³‡æ–™å³å¯ç²å–çµæœã€‚</p>
<pre><code>
import { count, sum, average } from './client';

// ç²å–ç¸½æ•¸ (Server-side COUNT)
const total = await sdk.collection('users').count();

// è¤‡é›œèšåˆ (Server-side SUM/AVG)
const stats = await sdk.collection('orders')
  .where('status', '==', 'shipped')
  .aggregate({
    orderCount: count(),
    totalRevenue: sum('amount'),
    avgAmount: average('amount')
  });

console.log('ç¸½è¨‚å–®æ•¸ï¼š', stats.orderCount);
console.log('ç¸½ç‡Ÿæ”¶ï¼š', stats.totalRevenue);
</code></pre>

<h2>9. è®€å¯«äº¤æ˜“ï¼ˆTransactionsï¼‰</h2>
<p>äº¤æ˜“ç¢ºä¿äº†ã€Œè®€å–-ä¿®æ”¹-å¯«å…¥ã€éç¨‹çš„åŸå­æ€§ã€‚å¦‚æœè³‡æ–™åœ¨è®€å–å¾Œè¢«ä¿®æ”¹ï¼Œäº¤æ˜“æœƒè‡ªå‹•é‡è©¦ã€‚</p>
<pre><code>
await sdk.runTransaction(async (transaction) => {
    const docRef = sdk.doc('counters', 'likes');
    
    // è®€å–æœ€æ–°å€¼
    const doc = await transaction.get(docRef);
    const newVal = (doc?.count || 0) + 1;
    
    // å¯«å…¥å›è³‡æ–™åº« (å¸¶æœ‰ç‰ˆæœ¬æ ¡é©—)
    transaction.update(docRef, { count: newVal });
});
</code></pre>

<h2>10. é›¢ç·šæŒä¹…åŒ–ï¼ˆPersistenceï¼‰</h2>
<p>å•Ÿç”¨å¾Œï¼ŒSDK æœƒå°‡è³‡æ–™å¿«ç…§å„²å­˜åœ¨ç€è¦½å™¨çš„ IndexedDB ä¸­ã€‚é‡æ–°è¼‰å…¥é é¢æ™‚æœƒç«‹å³é¡¯ç¤ºèˆŠæ•¸æ“šï¼Œææ˜‡æ¥µé€Ÿå•Ÿå‹•é«”é©—ã€‚</p>
<pre><code>
// å•Ÿå‹•æŒä¹…åŒ–
await sdk.enablePersistence();

sdk.collection('users').onSnapshot(({ record, metadata }) => {
    if (metadata.fromCache) {
        console.log('æ•¸æ“šä¾†è‡ªæœ¬åœ°å¿«å–');
    }
    renderUI(record);
});
</code></pre>

<h2>11. å­é›†åˆèˆ‡é›†åˆç¾¤çµ„ï¼ˆSubcollectionsï¼‰</h2>
<p>æä¾›èˆ‡ Firestore ä¸€è‡´çš„åµŒå¥—è·¯å¾‘èªæ³•ï¼Œç°¡åŒ–å¤–éµæŸ¥è©¢æµç¨‹ã€‚</p>
<pre><code>
// å­é›†åˆï¼šç²å–æŒ‡å®šæ–‡ä»¶çš„é—œè¯è³‡æ–™
const userPosts = sdk.doc('users', 1).collection('posts');
const list = await userPosts.get();

// é›†åˆç¾¤çµ„ï¼šè·¨æ–‡ä»¶çš„å»£åŸŸæœå°‹
const allComments = await sdk.collectionGroup('comments').get();
</code></pre>

<h2>12. åƒè€ƒèˆ‡å°èˆªï¼ˆReferences & Navigationï¼‰</h2>
<p>SDK æä¾›å¼·å¤§çš„å±¬æ€§ä¾†å”åŠ©æ‚¨ç®¡ç†è³‡æºå®šä½èˆ‡å°èˆªã€‚</p>
<pre><code>
// 1. è‡ªå‹•ç”Ÿæˆ ID
const newDocRef = sdk.collection('users').doc();
console.log('ç”Ÿæˆçš„ IDï¼š', newDocRef.id);

// 2. add() å‚³å›æ–‡ä»¶åƒè€ƒ
const ref = await sdk.collection('posts').add({ title: 'Hello' });
console.log('æ–°æ–‡ç« è·¯å¾‘ï¼š', ref.path);

// 3. å±¬æ€§å°èˆª
const userRef = sdk.doc('users', 'raybird');
console.log(userRef.id);   // 'raybird'
console.log(userRef.path); // 'public/users/raybird'
const parentCol = userRef.parent; // è¿”å› Collection ç‰©ä»¶
</code></pre>

<p>æ›´å¤š API é€ŸæŸ¥è«‹è¦‹ï¼š<code>docs/firestore-realtime-cheatsheet.md</code></p>
