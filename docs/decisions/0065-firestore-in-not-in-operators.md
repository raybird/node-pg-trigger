# ADR 0065: 補齊 Firestore 風格 in / not-in 查詢運算子

## 狀態

已接受 (Accepted)

## 背景

目前 SDK 已支援 `where`, `orderBy`, `limit`，但缺少 Firestore 開發者常用的集合查詢語法（`in` / `not-in`）。這使得角色、狀態等多值條件需要拆成多次查詢或客戶端二次過濾，降低可讀性與開發效率。

## 決策

在 SDK 與後端查詢編譯器同時加入 `in` 與 `not-in`：

1. **SDK 端**：`FilterOperator` 擴充為 `in` / `not-in`，客戶端快取比對邏輯同步支援。
2. **Server 端**：SQL 轉譯採參數化 `= ANY($n)` 與 `NOT (... = ANY($n))`。
3. **容錯策略**：若條件值非陣列，自動包裝成單元素陣列，避免常見使用錯誤。

## 後果

- **優點**：更貼近 Firestore 使用習慣，查詢語法更精簡。
- **優點**：即時訂閱與初始查詢可共用同一套條件語義。
- **缺點**：`not-in` 在 `NULL` 欄位上的 SQL 三值邏輯需由使用者注意資料模型設計。
